# Описание бота для игры "Морской Бой"

## Основные правила и понятия

### Игровые элементы

**Размер поля**: Игровое поле представляет собой квадратную сетку 10×10 клеток с координатами от (0,0) до (9,9).

**Типы кораблей**: Согласно классическим правилам "Морского Боя", флот состоит из:
- 1 корабль размера 4 клетки (четырехтрубный)
- 2 корабля размера 3 клетки (трехтрубные)
- 3 корабля размера 2 клетки (двухтрубные)
- 4 корабля размера 1 клетка (однотрубные)

**Результаты выстрелов**:
- **SHOT_RESULT_EMPTY** (0): Промах - выстрел пришелся в пустую клетку
- **SHOT_RESULT_DAMAGE** (2): Попадание - выстрел попал в корабль, но не уничтожил его
- **SHOT_RESULT_KILL** (3): Уничтожение - выстрел полностью уничтожил корабль

### Система состояний клеток

Бот отслеживает состояние каждой клетки игрового поля:

- **CELL_UNKNOWN** (0): Неизвестная клетка - еще не стреляли
- **CELL_MISS** (1): Промах - подтверждено, что в клетке нет корабля
- **CELL_HIT** (2): Попадание - в клетке есть часть корабля
- **CELL_KILLED** (3): Уничтоженный корабль - клетка является частью уничтоженного корабля
- **CELL_IMPOSSIBLE** (4): Невозможная клетка - гарантированно пустая (вокруг уничтоженного корабля)

## Принцип работы системы принятия решений

### Режимы работы бота

Бот работает в двух основных режимах, которые автоматически переключаются в зависимости от результатов стрельбы:

1. **Режим поиска (MODE_HUNT)**: Начальный режим, когда нет информации о местоположении кораблей противника
2. **Режим прицеливания (MODE_TARGET)**: Активируется при попадании в корабль для его полного уничтожения

### Инициализация и первый ход

При запуске новой серии игры (`onSetStart()`) происходит полная инициализация:

1. **Очистка поля**: Все клетки устанавливаются в состояние CELL_UNKNOWN
2. **Инициализация флота**: Устанавливаются счетчики кораблей: 4 однотрубных, 3 двухтрубных, 2 трехтрубных, 1 четырехтрубный
3. **Установка начального режима**: currentMode := MODE_HUNT
4. **Инициализация поиска**: hunt_n := 4 (максимальная плотность поиска), генерация списка клеток для стрельбы
5. **Сброс прицеливания**: Сброс всех переменных целевого режима

### Алгоритм принятия решений для стрельбы

1. **Проверка режима**: Система определяет, в каком режиме находится бот
2. **Генерация координат**: Выбираются координаты для следующего выстрела
3. **Обновление истории**: Сохранение последнего выстрела в переменной lastShot
4. **Возврат результата**: Возврат массива координат [строка, столбец]

## Стратегии поиска и прицеливания

### Режим поиска (Hunt Mode) - Алгоритм сетки

**Основная идея**: Поиск кораблей по оптимизированной сетке с регулируемой плотностью.

**Формула выбора клеток**:
```
if (r mod n < 2) and (c mod n < 2) and (field[r, c] == CELL_UNKNOWN)
```

где:
- `r` - номер строки (0-9)
- `c` - номер столбца (0-9)  
- `n` - параметр плотности поиска (4, 3, 2, 1)

**Сетка поиска с параметром n=4**:

|     | 0   | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0   | 1   | .   | .   | .   | 2   | .   | .   | .   | 3   | .   |
| 1   | .   | 10  | .   | .   | .   | 11  | .   | .   | .   | 12  |
| 2   | .   | .   | 19  | .   | .   | .   | 20  | .   | .   | .   |
| 3   | .   | .   | .   | 23  | .   | .   | .   | 24  | .   | .   |
| 4   | 4   | .   | .   | .   | 5   | .   | .   | .   | 6   | .   |
| 5   | .   | 13  | .   | .   | .   | 14  | .   | .   | .   | 15  |
| 6   | .   | .   | 21  | .   | .   | .   | 22  | .   | .   | .   |
| 7   | .   | .   | .   | 25  | .   | .   | .   | 26  | .   | .   |
| 8   | 7   | .   | .   | .   | 8   | .   | .   | .   | 9   | .   |
| 9   | .   | 16  | .   | .   | .   | 17  | .   | .   | .   | 18  |

**Алгоритм деградации плотности**:

Система начинает с максимальной плотности поиска (n=4) и при исчерпании всех клеток по данной формуле постепенно уменьшает параметр:

- **n = 4** → **n = 3** → **n = 2** → **n = 1**

При n=1 формула `(r mod 1 < 2)` всегда истинна, что означает проверку всех оставшихся неизвестных клеток.

**Процесс генерации списка поиска** (`initHuntCells(n)`):

1. **Очистка массива**: Устанавливается пустая длина массива huntCells
2. **Параллельный обход**: Перебор всех строк (0→9), затем столбцов (0→9)
3. **Проверка условий**: Для каждой клетки проверяется:
   - Соответствие формуле плотности
   - Состояние CELL_UNKNOWN
4. **Добавление в массив**: Подходящие клетки добавляются в huntCells в порядке обхода
5. **Сброс индекса**: huntIndex := 0 для начала нового цикла поиска

**Процесс получения следующего выстрела** (`getNextHuntShot()`):

1. **Проверка индекса**: Проверка, не превышает ли huntIndex длину массива
2. **Извлечение клетки**: Получение координат из huntCells[huntIndex]
3. **Инкремент индекса**: Переход к следующей клетке в массиве
4. **Проверка состояния**: Убеждение, что клетка все еще неизвестна
5. **Возврат результата**: Возврат найденной клетки или false при исчерпании

### Режим прицеливания (Target Mode)

**Условия активации**: Режим прицеливания включается при получении результата SHOT_RESULT_DAMAGE (попадание).

**Принцип работы**:

1. **Сбор информации о попаданиях**: Добавление координат попадания в массив targetHits
2. **Определение направления**: При 2+ попаданиях определение ориентации корабля
3. **Генерация целевых клеток**: Расчет всех возможных клеток для следующего выстрела
4. **Приоритизация**: Выбор оптимальной клетки из списка возможных

**Алгоритм определения направления** (`detectDirection()`):

При наличии минимум 2 попаданий система анализирует их координаты:
- Если попадания находятся в одной строке (row одинаковый) → DIR_HORIZONTAL
- Если попадания находятся в одном столбце (col одинаковый) → DIR_VERTICAL
- При недостатке данных → DIR_NONE

**Генерация возможных выстрелов**:

*Для одиночного попадания* (`getPossibleShotsForSingleHit()`):

Система проверяет 4 соседние клетки вокруг попадания:
- Вверх: (row-1, col)
- Вправо: (row, col+1)  
- Вниз: (row+1, col)
- Влево: (row, col-1)

*Для горизонтального корабля* (`getPossibleShotsForHorizontal()`):

1. **Сортировка по столбцам**: Упорядочивание попаданий слева направо
2. **Заполнение пробелов**: Проверка неизвестных клеток между крайними попаданиями
3. **Проверка продолжений**: Анализ клеток слева от минимального и справа от максимального столбца

*Для вертикального корабля* (`getPossibleShotsForVertical()`):

1. **Сортировка по строкам**: Упорядочивание попаданий сверху вниз
2. **Заполнение пробелов**: Проверка неизвестных клеток между крайними попаданиями
3. **Проверка продолжений**: Анализ клеток сверху от минимальной и снизу от максимальной строки

## Обработка результатов выстрелов

### Алгоритм обработки (`shotResult_v2()`)

**Проверка валидности координат**:

1. **Проверка диапазона**: Убеждение, что координаты находятся в пределах поля [0,9]
2. **Проверка инициализации**: Игнорирование неинициализированных выстрелов (координаты -1)

**Обработка по типу результата**:

*SHOT_RESULT_EMPTY (промах)*:
- Установка клетки в состояние CELL_MISS
- Продолжение текущего режима без изменений

*SHOT_RESULT_DAMAGE (попадание)*:
- Установка клетки в состояние CELL_HIT
- Добавление координат в массив targetHits
- Увеличение счетчика targetHitsCount
- Переключение в режим MODE_TARGET
- При наличии 2+ попаданий вызов detectDirection()

*SHOT_RESULT_KILL (уничтожение)*:
- Установка клетки в состояние CELL_HIT (перед конвертацией)
- Добавление координат в targetHits
- Конвертация всех попаданий в CELL_KILLED (`convertHitsToKilled()`)
- Отметка клеток вокруг корабля как CELL_IMPOSSIBLE (`markAroundShipAsImpossible()`)
- Обновление счетчика оставшихся кораблей
- Возврат в режим MODE_HUNT с полным сбросом целевых параметров

### Алгоритм отметки невозможных клеток (`markAroundShipAsImpossible()`)

**Принцип работы**: После уничтожения корабля все клетки вокруг него гарантированно пусты.

**Процесс выполнения**:

1. **Обход всех попаданий**: Перебор всех клеток уничтоженного корабля
2. **Анализ окрестности**: Для каждой клетки проверка 8 соседних позиций
3. **Пропуск центра**: Исключение самой клетки корабля (dr=0, dc=0)
4. **Проверка границ**: Убеждение, что клетка находится в пределах поля
5. **Отметка невозможности**: Установка состояния CELL_IMPOSSIBLE для подходящих клеток

## Практические примеры работы системы

### Пример 1: Первая серия попаданий

**Сценарий**: Бот в режиме поиска делает выстрел и попадает в корабль противника.

| Шаг | Действие | Режим | Координаты | Результат | Объяснение |
| --- | -------- | ----- | ---------- | --------- | ---------- |
| 1   | Нача | MODE_HUNT | (4,0) | SHOT_RESULT_EMPTY | Промах, клетка отмечается как CELL_MISS |
| 2   | Поиск | MODE_HUNT | (0,4) | SHOT_RESULT_EMPTY | Промах по формуле сетки n=4 |
| 3   | Поиск | MODE_HUNT | (4,4) | SHOT_RESULT_DAMAGE | Попадание! Переключение в MODE_TARGET |
| 4   | Прицеливание | MODE_TARGET | (4,5) | SHOT_RESULT_EMPTY | Стрельба справа от попадания - промах |
| 5   | Прицеливание | MODE_TARGET | (3,4) | SHOT_RESULT_DAMAGE | Стрельба сверху - еще одно попадание! |
| 6   | Прицеливание | MODE_TARGET | (2,4) | SHOT_RESULT_KILL | Стрельба дальше вверху - уничтожение! |
| 7   | Очистка | MODE_HUNT | - | - | Возврат к поиску, отметка невозможных клеток |

**Анализ**: Система успешно обнаружила вертикальный корабль длиной 3 клетки в столбце 4 (координаты (4,4), (3,4), (2,4)). После уничтожения все клетки вокруг корабля помечаются как невозможные.

### Пример 2: Поиск горизонтального корабля

**Сценарий**: Бот обнаруживает горизонтальный корабль и определяет его ориентацию.

| Шаг | Действие | Режим | Координаты | Результат | Объяснение |
| --- | -------- | ----- | ---------- | --------- | ---------- |
| 1   | Попадание | MODE_TARGET | (7,6) | SHOT_RESULT_DAMAGE | Первое попадание, переход в режим прицеливания |
| 2   | Проверка соседей | MODE_TARGET | (7,5) | SHOT_RESULT_EMPTY | Стрельба слева - промах |
| 3   | Проверка соседей | MODE_TARGET | (7,7) | SHOT_RESULT_DAMAGE | Стрельба справа - попадание! |
| 4   | Определение направления | MODE_TARGET | - | - | Два попадания в одной строке = DIR_HORIZONTAL |
| 5   | Заполнение пробелов | MODE_TARGET | (7,8) | SHOT_RESULT_EMPTY | Проверка между попаданиями - промах |
| 6   | Продолжение | MODE_TARGET | (7,9) | SHOT_RESULT_DAMAGE | Стрельба справа от правого попадания - попадание |
| 7   | Уничтожение | MODE_TARGET | (7,10) | SHOT_RESULT_KILL | Стрельба в конец корабля - уничтожение |

**Анализ**: Система распознала горизонтальный корабль в строке 7, состоящий из клеток (7,6), (7,7), (7,9). Промежуточная клетка (7,8) оказалась пустой.

### Пример 3: Алгоритм деградации плотности поиска

**Сценарий**: После исчерпания всех клеток с максимальной плотностью бот переходит к более плотному поиску.

| Этап | Параметр n | Формула | Количество клеток | Описание |
| ---- | ---------- | ------- | ------------------ | -------- |
| 1 | n=4 | `(r mod 4 < 2) и (c mod 4 < 2)` | 26 клеток | Максимальная плотность поиска по сетке |
| 2 | n=3 | `(r mod 3 < 2) и (c mod 3 < 2)` | ~40 клеток | Средняя плотность поиска |
| 3 | n=2 | `(r mod 2 < 2) и (c mod 2 < 2)` | ~60 клеток | Низкая плотность поиска |
| 4 | n=1 | `(r mod 1 < 2) и (c mod 1 < 2)` | Все оставшиеся | Полный перебор оставшихся клеток |

**Логика переключения**: При исчерпании всех клеток текущей плотности поиска (huntIndex достигает конца huntCells), система автоматически уменьшает параметр n на единицу и перегенерирует список поиска.

### Пример 4: Обработка однотрубного корабля

**Сценарий**: Особенности работы с кораблями размера 1 клетка.

| Шаг | Действие | Режим | Координаты | Результат | Особенности |
| --- | -------- | ----- | ---------- | --------- | ----------- |
| 1   | Попадание | MODE_TARGET | (5,2) | SHOT_RESULT_DAMAGE | Первое попадание |
| 2   | Проверка соседей | MODE_TARGET | (4,2) | SHOT_RESULT_EMPTY | Проверка сверху - промах |
| 3   | Проверка соседей | MODE_TARGET | (6,2) | SHOT_RESULT_EMPTY | Проверка снизу - промах |
| 4   | Проверка соседей | MODE_TARGET | (5,1) | SHOT_RESULT_EMPTY | Проверка слева - промах |
| 5   | Проверка соседей | MODE_TARGET | (5,3) | SHOT_RESULT_KILL | Проверка справа - уничтожение! |
| 6   | Возврат к поиску | MODE_HUNT | - | - | Так как корабль уничтожен с первого попадания |

**Анализ**: При попадании в однотрубный корабль система проверяет все 4 соседние клетки. При отсутствии дополнительных попаданий в следующем выстреле корабль считается уничтоженным.

## Схема алгоритма

### Основной цикл работы бота

```
onSetStart() → Инициализация → MODE_HUNT → internal_shoot()
                                                    ↓
                                            Проверка режима
                                                    ↓
                    ┌─────────────────────┬─────────────────────┐
                    │                     │                     │
            MODE_TARGET            MODE_HUNT              MODE_HUNT
                    │                     │                     │
            getPossibleShots()    getNextHuntShot()      getNextHuntShot()
                    │                     │                     │
                    ↓                     ↓                     ↓
            shotResult_v2()         Если клетки исчерпаны    Следующий выстрел
                    │                     │                     │
                    ↓                     ↓                     ↓
            SHOT_RESULT_DAMAGE     Уменьшить n и             Если n>1
                    │             перегенерировать          продолжить
                    │                     │                     │
                    ↓                     │                     │
            Добавить в targetHits        │                     │
                    │                     │                     │
                    ↓                     │                     │
            Если 2+ попаданий            │                     │
            detectDirection()            │                     │
```

### Переходы между режимами

- **MODE_HUNT → MODE_TARGET**: При получении SHOT_RESULT_DAMAGE
- **MODE_TARGET → MODE_HUNT**: При получении SHOT_RESULT_KILL или исчерпании возможных выстрелов

### Состояния системы

| Состояние | Описание | Триггеры перехода |
| --------- | -------- | ----------------- |
| **Инициализация** | Очистка поля, установка начальных значений | `onSetStart()` |
| **Поиск с плотностью n=4** | Поиск по сетке максимальной плотности | Начало игры |
| **Поиск с плотностью n=3** | Переход к средней плотности | Исчерпание n=4 |
| **Поиск с плотностью n=2** | Переход к низкой плотности | Исчерпание n=3 |
| **Поиск с плотностью n=1** | Полный перебор | Исчерпание n=2 |
| **Прицеливание (одиночное)** | Стрельба вокруг единственного попадания | SHOT_RESULT_DAMAGE |
| **Прицеливание (линейное)** | Стрельба вдоль линии корабля | 2+ SHOT_RESULT_DAMAGE |
| **Уничтожение корабля** | Завершение уничтожения | SHOT_RESULT_KILL |
| **Возврат к поиску** | Переход обратно к поиску | После SHOT_RESULT_KILL |

## Оптимизация и производительность

### Временная сложность алгоритмов

- **Инициализация поиска** (n=4): O(n²) = O(100) - генерация списка из 26 клеток
- **Получение следующего выстрела**: O(1) - извлечение из предварительно сгенерированного списка
- **Определение направления**: O(1) - сравнение координат попаданий
- **Генерация возможных выстрелов**: O(k) где k ≤ 8 - проверка соседних клеток
- **Отметка невозможных клеток**: O(s×8) где s - размер корабля (максимум 32 операции)

### Оптимизации памяти

- **Статические массивы**: Фиксированный размер 10×10 для поля и массивов попаданий
- **Динамический список поиска**: Использование SetLength для массива huntCells
- **Перезапись против удаления**: Замена значений в массивах вместо удаления элементов

### Эффективность стратегии поиска

**Преимущества алгоритма сетки**:

1. **Минимизация холостых выстрелов**: Сетка n=4 покрывает поле максимально равномерно
2. **Гарантированное обнаружение**: При n=1 достигается полный перебор
3. **Адаптивность**: Плавный переход от грубого к точному поиску

**Недостатки**:
1. **Локальные пробелы**: При n=4 между клетками поиска остаются большие области
2. **Зависимость от удачи**: Эффективность зависит от удачного первого попадания

## Заключение

Описанный бот для игры "Морской Бой" демонстрирует эффективное сочетание двух ключевых стратегий: систематического поиска по сетке и целевого прицеливания. Алгоритм с регулируемой плотностью поиска обеспечивает быстрое обнаружение кораблей, а режим прицеливания гарантирует их полное уничтожение с минимальным количеством выстрелов.

Система адаптируется к различным типам кораблей и эффективно обрабатывает краевые случаи, такие как однотрубные корабли и корабли у границ поля. Автоматический переход между режимами и грамотное управление состоянием поля делают бота надежным и предсказуемым игроком в классической игре "Морской Бой".
