# Описание бота для игры "Камень-Ножницы-Бумага"

## Основные правила и понятия

### Игровые элементы

- **Возможные ходы**: Камень, Бумага, Ножницы
- **Результаты раундов**: Победа, Поражение, Ничья
- **Принцип побед**: 
  - **Камень** побеждает **Ножницы**
  - **Бумага** побеждает **Камень**
  - **Ножницы** побеждают **Бумагу**

### Система хранения данных

Бот ведет учет последних 1000 раундов, сохраняя:
- Последовательность ходов противника
- Собственные выбранные ходы
- Результаты каждого раунда

## Принцип работы системы принятия решений

### Инициализация и первый ход

При первом обращении (когда от сервера приходит сигнал о начале игры с нулевым значением) система инициализируется и выбирает **бумагу** как свой первый ход. После получения первого хода противника, система уже имеет начальную точку для анализа - один завершенный раунд с известным результатом.

### Алгоритм принятия решений для последующих ходов

1. **Запись данных**: Сохранение последнего хода противника и вычисление результата предыдущего раунда
2. **Обновление счетчика поражений**: При поражении счетчик увеличивается, при победе или ничьей сбрасывается
3. **Проверка смены метода**: При достижении ровно 5 поражений подряд происходит переключение между методами анализа, счетчик сбрасывается
4. **Адаптация параметров**: Анализ общего процента побед и корректировка внутренних параметров
5. **Предсказание**: Прогнозирование следующего хода противника текущим активным методом
6. **Выбор ответа**: Если метод дал прогноз - используется контр-ход, если нет - используется **бумага** по умолчанию
7. **Обновление истории**: Сохранение собственного хода

**Важно**: Система НЕ переключается между методами при неудаче прогноза. Смена метода происходит ТОЛЬКО после 5 поражений подряд. Если текущий метод не может дать прогноз (недостаточно данных), система использует **бумагу** по умолчанию, но метод остается прежним.

## Стратегии анализа

Система использует два метода анализа поведения противника:
- **Метод 1**: Поиск повторяющихся последовательностей (паттернов)
- **Метод 2**: Частотный анализ с весовой системой

### Метод 1: Поиск паттернов

**Требования**: Минимум 5 сыгранных раундов в истории.

**Детальный процесс поиска**:

Система работает по принципу "от длинного к короткому" - сначала ищет длинные совпадения, затем постепенно сокращает длину поиска.

**Этап 1: Выбор длины паттерна**
- Начинает с максимальной длины (от 6 до 14 ходов, по умолчанию 10)
- Постепенно уменьшает до минимума 2 хода
- На каждой длине проводит полный поиск по всей истории

**Этап 2: Определение текущего паттерна**
- Берет последние N ходов противника как "текущий паттерн"
- Например, если длина = 3, а последние ходы были [Камень, Бумага, Ножницы], то текущий паттерн = [Камень, Бумага, Ножницы]

**Этап 3: Поиск совпадений в истории**
- Проходит по всей истории игры от начала до конца
- Для каждой позиции проверяет: совпадает ли последовательность ходов с текущим паттерном посимвольно
- Если находит полное совпадение И после этого совпадения есть еще хотя бы один ход - запоминает этот следующий ход

**Пример поиска**:
```
История: [К, Б, Н, К, Б, Н, К, Б, Н]
Текущий паттерн (последние 3 хода): [К, Б, Н]

Поиск совпадений:
- Позиция 0: [К, Б, Н] == [К, Б, Н]? ✓ Совпадает! После был ход на позиции 3: К
- Позиция 1: [Б, Н, К] == [К, Б, Н]? ✗ Не совпадает
- Позиция 2: [Н, К, Б] == [К, Б, Н]? ✗ Не совпадает
- Позиция 3: [К, Б, Н] == [К, Б, Н]? ✓ Совпадает! После был ход на позиции 6: К
- ...и так далее
```

**Этап 4: Оценка каждого найденного совпадения**

Для каждого найденного совпадения вычисляется оценка по формуле:

```
Базовая оценка = длина_паттерна × (2.0 + уровень_адаптации)

Модификация по результату раунда, который был ПОСЛЕ найденного паттерна:
- Если после паттерна бот ВЫИГРАЛ:  оценка + 10 баллов
- Если после паттерна была НИЧЬЯ:   оценка + 3 балла
- Если после паттерна бот ПРОИГРАЛ: оценка - 6 баллов
```

**Смысл оценки**: 
- Длинные паттерны ценнее (больше базовая оценка)
- Паттерны, после которых бот выигрывал в прошлом, получают бонус
- Паттерны, после которых бот проигрывал, получают штраф
- Система запоминает **лучший** паттерн по оценке среди всех найденных совпадений данной длины

**Этап 5: Проверка надежности**

После проверки всех позиций для текущей длины:
- Если лучшая оценка >= 12 баллов - система считает прогноз надежным и немедленно возвращает предсказанный ход
- Если оценка < 12 - продолжает поиск с меньшей длиной паттерна

**Этап 6: Финальное решение**

После проверки всех длин от максимальной до 2:
- Если нашелся хоть какой-то паттерн с положительной оценкой - используется лучший из них
- Если ничего не найдено - возвращается "нет прогноза" (будет использована бумага по умолчанию)

**Конкретный пример расчета** (при уровне адаптации 0.6):

```
Найден паттерн длины 3: [Камень, Бумага, Ножницы]
Базовая оценка = 3 × (2.0 + 0.6) = 3 × 2.6 = 7.8

Случай 1: После этого паттерна в прошлом бот выиграл
Финальная оценка = 7.8 + 10 = 17.8 ✓ (больше 12, используем сразу!)

Случай 2: После этого паттерна в прошлом бот проиграл
Финальная оценка = 7.8 - 6 = 1.8 ✗ (меньше 12, ищем дальше)

Случай 3: Найден паттерн длины 5 с ничьей
Базовая оценка = 5 × 2.6 = 13.0
Финальная оценка = 13.0 + 3 = 16.0 ✓ (отличный результат!)
```

**Важная деталь**: Если один и тот же паттерн встречается несколько раз, система рассматривает каждое вхождение отдельно и выбирает то, которое дает лучшую оценку с учетом результата следующего хода.

### Метод 2: Частотный анализ с весами

**Требования**: Минимум 3 сыгранных раунда в истории.

**Окно анализа**: Система анализирует последние 50-120 раундов (по умолчанию 80).

**Как работает**:

Система присваивает каждому ходу вес по формуле:

```
Фактор новизны = позиция_хода_в_окне / размер_окна
Базовый вес = 0.2 + фактор_новизны × 0.8

Итоговый вес = базовый_вес × (1.0 + уровень_адаптации)

Если после этого хода был проигрыш:
  вес умножается на 2
```

**Принцип весов**:
- Старые ходы получают меньший вес (минимум 0.2)
- Свежие ходы получают больший вес (максимум 1.0)
- Все веса усиливаются уровнем адаптации (множитель от 1.4 до 2.0)
- Если после хода противника бот проиграл, вес этого хода удваивается (система считает, что противник может повторить успешный ход)

**Выбор прогноза**: Система суммирует веса для Камня, Бумаги и Ножниц отдельно и выбирает тот ход, который набрал наибольший суммарный вес.

**Пример расчета** (при уровне адаптации 0.6):
- Самый старый ход в окне: вес = 0.2 × 1.6 = 0.32
- Самый новый ход: вес = 1.0 × 1.6 = 1.6
- Если после хода был проигрыш: вес = 1.6 × 2.0 = 3.2

### Переключение между методами

**Триггер переключения**: 5 поражений подряд.

**Механизм**:
- Система начинает с метода поиска паттернов
- При каждом поражении увеличивается счетчик неудач
- При достижении 5 поражений методы меняются местами
- При победе или ничьей счетчик сбрасывается

## Адаптивная настройка параметров

### Концепция

Система непрерывно отслеживает свою эффективность и автоматически настраивает три внутренних параметра после каждого хода.

### Отслеживаемые метрики

**Процент побед** = количество_побед / общее_количество_раундов

### Настраиваемые параметры

1. **Уровень адаптации** (от 0.4 до 1.0, старт: 0.6)
   - Влияет на чувствительность оценки паттернов
   - Влияет на силу весов в частотном анализе

2. **Максимальная длина паттернов** (от 6 до 14, старт: 10)
   - Определяет, насколько длинные последовательности искать

3. **Размер окна анализа** (от 50 до 120, старт: 80)
   - Определяет, сколько последних раундов учитывать в частотном анализе

### Режимы адаптации

**При высокой эффективности (процент побед > 60%)**:
- Уровень адаптации увеличивается на 0.04
- Длина паттернов увеличивается на 1
- Окно анализа увеличивается на 8
- *Смысл*: Текущая стратегия работает хорошо, можно усилить агрессивность

**При низкой эффективности (процент побед < 45%)**:
- Уровень адаптации уменьшается на 0.06
- Длина паттернов уменьшается на 1
- Окно анализа уменьшается на 10
- *Смысл*: Текущая стратегия не работает, нужно упростить подход

**При длительной игре (более 150 раундов)**:
- Если уровень адаптации выше 0.5, он уменьшается на 0.02
- *Смысл*: Предотвращение чрезмерной подстройки под конкретного противника

## Практические примеры

### Пример 1: Противник с циклическим паттерном

**Сценарий**: Противник играет повторяющийся цикл "Камень-Бумага-Ножницы-Камень-Бумага-Ножницы..."

| Раунд | Ход противника | Что происходит                                                                                               | Прогноз | Наш ход | Результат  |
| ----- | -------------- | ------------------------------------------------------------------------------------------------------------ | ------- | ------- | ---------- |
| 1     | Камень         | Инициализация, первый ход                                                                                    | -       | Бумага  | **Победа** |
| 2     | Бумага         | Недостаточно истории (1 завершенный раунд)                                                                   | -       | Бумага  | Ничья      |
| 3     | Ножницы        | Недостаточно истории (2 раунда)                                                                              | -       | Бумага  | Поражение  |
| 4     | Камень         | Недостаточно истории (3 раунда)                                                                              | -       | Бумага  | **Победа** |
| 5     | Бумага         | Недостаточно истории (4 раунда)                                                                              | -       | Бумага  | Ничья      |
| 6     | Ножницы        | Минимум достигнут (5 раундов). Ищем паттерны, но они еще слабые                                              | Камень? | Бумага  | Поражение  |
| 7     | Камень         | Найден паттерн [Камень,Бумага,Ножницы] длины 3, повторяется! После первого был Камень. Оценка: 3×2.6+10=17.8 | Камень  | Бумага  | **Победа** |
| 8     | Бумага         | Паттерн [Бумага,Ножницы,Камень] повторяется. После был Бумага. Оценка высокая                                | Бумага  | Ножницы | **Победа** |
| 9     | Ножницы        | Паттерн [Ножницы,Камень,Бумага] повторяется. После был Ножницы. Оценка высокая                               | Ножницы | Камень  | **Победа** |
| 10    | Камень         | Длинные паттерны подтверждаются, цикл распознан                                                              | Камень  | Бумага  | **Победа** |

### Пример 2: Противник меняет стратегию

**Сценарий**: Противник сначала часто играет Камень (6 раз), затем переходит на Бумагу.

**Используется частотный анализ** (допустим, переключились после неудач в предыдущей игре).

| Раунд | Ход противника | Распределение весов                                                                                                                  | Прогноз            | Наш ход | Результат  |
| ----- | -------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ------------------ | ------- | ---------- |
| 6     | Камень         | Камень доминирует (6 ходов с весами 0.32-1.6, некоторые удвоены из-за проигрышей). Сумма весов: Камень ≈ 10, Бумага ≈ 0, Ножницы ≈ 0 | Камень             | Бумага  | **Победа** |
| 7     | Камень         | Камень все еще доминирует (7 ходов). Последний имеет вес 1.6. Сумма: Камень ≈ 12, остальные ≈ 0                                      | Камень             | Бумага  | **Победа** |
| 8     | Бумага         | Камень: 7 старых ходов, Бумага: 1 новый ход (вес 1.6). Камень все еще впереди: К ≈ 10, Б ≈ 1.6                                       | Камень             | Бумага  | Ничья      |
| 9     | Бумага         | Камень: 7 старых, Бумага: 2 новых (веса 1.4 и 1.6). Камень начинает терять вес: К ≈ 8, Б ≈ 3                                         | Камень             | Бумага  | Ничья      |
| 10    | Бумага         | Бумага: 3 новых хода с высокими весами. Бумага начинает доминировать: Б ≈ 4.5, К ≈ 6                                                 | Камень             | Бумага  | Ничья      |
| 11    | Ножницы        | Бумага: 3 хода, Ножницы: 1 новый (вес 1.6). Б ≈ 4, Н ≈ 1.6, К ≈ 5                                                                    | Камень             | Бумага  | Поражение  |
| 12    | Бумага         | Бумага: 4 новых хода. Бумага выходит вперед: Б ≈ 5.5, К ≈ 4, Н ≈ 1.3                                                                 | Бумага             | Ножницы | **Победа** |
| 13    | Бумага         | Бумага: 5 новых ходов, явно доминирует: Б ≈ 7, К ≈ 3, Н ≈ 1                                                                          | Бумага             | Ножницы | **Победа** |
| 14    | Камень         | Появился новый Камень (вес 1.6). Бумага пока впереди: Б ≈ 6, К ≈ 4, Н ≈ 1                                                            | Бумага             | Ножницы | Поражение  |
| 15    | Ножницы        | Ножницы: 2 хода (последний × 2 от проигрыша = 3.2). Н ≈ 4.6, Б ≈ 5                                                                   | Бумага или Ножницы | Ножницы | Ничья      |

<img src="pics/flowchart.png" alt="Описание" width="95%">
